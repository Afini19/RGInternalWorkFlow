Imports System.IO
Imports System.Data
Imports System.Data.SqlClient
Imports System.Data.OleDb
Imports System.Web
Imports System.Web.UI
Imports System.Web.UI.WebControls

Partial Public Class wbuilderpreview_class
    Inherits listpage
    Private showtracking As Boolean = False
    'Generated by VI FEANDI SOFTLABS FORM GENERATOR (http://www.vifeandi.net) VER 2014.1

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        _searchkeystr = ""
        listingpage = ""
        _FormsName = "Workflow Builder"
        TableName = "workflowitems"
        DetailPage = "wd.aspx"
        IDPField = "wui_wid"
        IDField = "wui_id"
        AppIDField = ""
        MerchantIDField = ""
        FilterField = "wui_filter"
        Orderby = " order by isnull(wui_no,0) asc, wui_seq asc"
        APPCode = ""
        AddRights = ""
        DelRights = ""
        ModRights = ""
        ViewRights = ""
        FullRights = ""
        NmSpace = "workflowitems"
        pFieldNames = " * "
        pJoinFields = ""
        showtracking = True
        btnback.Visible = False

        If Page.IsPostBack = False Then
            pg.Value = Request("rc")
        End If
        If IsNumeric(pg.Value) = False Then
            pg.Value = 1
        End If

        _searchfilter = ""
        Call InitLoad()

        If Page.IsPostBack = False Then
            Call LoadDataHeader()
        End If

        showtracking = True
        Call LoadDataData()

    End Sub

    Private Sub assignname()
        _FormsName = "WORKFLOW : " & sname.Value
    End Sub

    Public Function LoadDataHeader() As Boolean
        Dim cn As New OleDbConnection(connectionstring)
        Dim cmd As New OleDbCommand()
        Dim ad As New OleDb.OleDbDataAdapter()
        Dim ds As New DataSet()
        Dim counter As Integer = 0
        Dim dr As DataRow

        If IsNumeric(rid.value) = False Then
            Exit Function
        End If

        Try
            cmd.CommandText = "Select * from [workflow] where wf_id=" & rid.Value
            cmd.Connection = cn
            ad.SelectCommand = cmd
            ad.Fill(ds, "datarecords")
            For Each dr In ds.Tables("datarecords").Rows
                counter = counter + 1
                sname.Value = dr("wf_name") & ""
                Exit For
            Next
            cn.Close()
            cmd.Dispose()
            cn.Dispose()
            Call assignname()
        Catch ex As Exception
            lblMessage.Text = WebLib.getAlertMessageStyle(ex.Message)
        End Try
    End Function

    Public Function LoadDataData() As Boolean
        Dim cn As New OleDbConnection(connectionstring)
        Dim cmd As New OleDbCommand()
        Dim ad As New OleDb.OleDbDataAdapter()
        Dim ds As New DataSet()
        Dim counter As Integer = 0
        Dim dr As DataRow
        If IsNumeric(rid.value) = False Then
            Exit Function
        End If

        Dim obj As ImageButton
        Dim lit As Literal
        Dim lwidth As String = "48px"
        Dim lheight As String = "48px"
        Dim isEnd As Boolean = False
        phMap.Controls.Clear()
        phStatus.Controls.Clear()

        lit = New Literal
        lit.Text = "Start of Workflow<br>"
        lit.ID = "lit00S"
        phMap.Controls.Add(lit)

        obj = New ImageButton
        obj.ImageUrl = WebLib.ClientURL("graphics/workflow/circlegreen.png")
        obj.Style.Add("width", lwidth)
        obj.Style.Add("height", lheight)
        phMap.Controls.Add(obj)

        '******* Status
        If showtracking = True Then
            lit = New Literal
            lit.Text = "Tracking<br>"
            phStatus.Controls.Add(lit)

            obj = New ImageButton
            obj.ImageUrl = WebLib.ClientURL("graphics/workflow/arrowdowngreen.png")
            obj.Style.Add("width", lwidth)
            obj.Style.Add("height", lheight)
            phStatus.Controls.Add(obj)

            lit = New Literal
            lit.Text = "<br>"
            phStatus.Controls.Add(lit)

            obj = New ImageButton
            obj.ImageUrl = WebLib.ClientURL("graphics/workflow/arrowdowngreen.png")
            obj.Style.Add("width", lwidth)
            obj.Style.Add("height", lheight)
            phStatus.Controls.Add(obj)

            lit = New Literal
            lit.Text = "<br>"
            phStatus.Controls.Add(lit)
        End If

        '**********


        lit = New Literal
        lit.Text = "<br>"
        phMap.Controls.Add(lit)

        lit = New Literal
        lit.Text = "<b>Audit Logs</b><br>"
        lit.ID = "AuditHeader"
        phAudit.Controls.Add(lit)

        obj = New ImageButton
        obj.ImageUrl = WebLib.ClientURL("graphics/workflow/arrowdown.png")
        obj.Style.Add("width", lwidth)
        obj.Style.Add("height", lheight)
        phMap.Controls.Add(obj)

        lit = New Literal
        lit.Text = "<br>"
        phMap.Controls.Add(lit)


        Dim bStop As Boolean = False

        Try
            cmd.CommandText = "Select " & TableName & ".*,workflowstatus.wst_level,wst_status from " & TableName & " inner join workflowstatus on wui_filter = wst_filtercode and wui_wid = wst_workflowid where wui_wid=" & rid.Value & " and wst_ucode='" & bid.Value & "' " & Orderby

            cmd.Connection = cn
            ad.SelectCommand = cmd
            ad.Fill(ds, "datarecords")
            For Each dr In ds.Tables("datarecords").Rows
                counter = counter + 1

                lit = New Literal
                lit.Text = "<span><b>" & dr("wui_name") & "</b></span><br>"
                phMap.Controls.Add(lit)


                '******* Status
                If showtracking = True Then
                    If bStop <> True Then
                        lit = New Literal
                        lit.Text = "<span><b>" & dr("wui_name") & "</b></span><br>"
                        phStatus.Controls.Add(lit)

                        If CLng(dr("wui_no")) < CLng(dr("wst_level")) Then
                            obj = New ImageButton
                            obj.ImageUrl = WebLib.ClientURL("graphics/workflow/arrowdowngreen.png")
                            obj.Style.Add("width", lwidth)
                            obj.Style.Add("height", lheight)
                            obj.ID = "objS" & dr("wui_id") & "S"
                            phStatus.Controls.Add(obj)

                            lit = New Literal
                            lit.Text = "<br>"
                            phStatus.Controls.Add(lit)
                            obj = New ImageButton
                            obj.ImageUrl = WebLib.ClientURL("graphics/workflow/arrowdowngreen.png")
                            obj.Style.Add("width", lwidth)
                            obj.Style.Add("height", lheight)
                            obj.ID = "objS2" & dr("wui_id") & "S2"
                            phStatus.Controls.Add(obj)

                            lit = New Literal
                            lit.Text = "<br>"
                            phStatus.Controls.Add(lit)

                        Else
                            obj = New ImageButton
                            obj.ImageUrl = WebLib.ClientURL("graphics/workflow/marker.png")
                            obj.Style.Add("width", lwidth)
                            obj.Style.Add("height", lheight)
                            obj.ID = "objS2" & dr("wui_id") & "S2"
                            phStatus.Controls.Add(obj)

                            lit = New Literal
                            lit.Text = "<br>"
                            phStatus.Controls.Add(lit)
                            bStop = True

                            obj = New ImageButton
                            obj.ImageUrl = Imagesimages.GetImagebyStatus(dr("wst_status") & "")
                            obj.Style.Add("height", lheight)
                            obj.ID = "objSS" & dr("wui_id") & "SS"
                            phStatus.Controls.Add(obj)


                        End If
                    End If
                End If
                '***********

                If WebLib.BitToBoolean(dr("wui_cancel")) = True Then


                    obj = New ImageButton
                    Select Case dr("wui_cancelstep")
                        Case "1"
                            obj.ImageUrl = WebLib.ClientURL("graphics/workflow/circleblue.png")
                        Case "3"
                            obj.ImageUrl = WebLib.ClientURL("graphics/workflow/circlegreen.png")
                        Case Else
                            obj.ImageUrl = WebLib.ClientURL("graphics/misc/blank.png")
                    End Select
                    obj.Style.Add("width", lwidth)
                    obj.Style.Add("height", lheight)
                    obj.ID = "obj" & dr("wui_id") & "LE"
                    phMap.Controls.Add(obj)

                    obj = New ImageButton
                    obj.ImageUrl = WebLib.ClientURL("graphics/workflow/arrowleftyellow.png")
                    obj.Style.Add("width", lwidth)
                    obj.Style.Add("height", lheight)
                    obj.ID = "obj" & dr("wui_id") & "L"
                    phMap.Controls.Add(obj)
                Else

                    obj = New ImageButton
                    obj.ImageUrl = WebLib.ClientURL("graphics/misc/blank.png")
                    obj.Style.Add("width", lwidth)
                    obj.Style.Add("height", lheight)
                    obj.ID = "obj" & dr("wui_id") & "LE"
                    phMap.Controls.Add(obj)

                    obj = New ImageButton
                    obj.ImageUrl = WebLib.ClientURL("graphics/misc/blank.png")
                    obj.Style.Add("width", lwidth)
                    obj.Style.Add("height", lheight)
                    obj.ID = "obj" & dr("wui_id") & "L"
                    phMap.Controls.Add(obj)

                End If

                obj = New ImageButton
                obj.ImageUrl = WebLib.ClientURL("graphics/workflow/group.png")
                obj.Style.Add("width", lwidth)
                obj.Style.Add("height", lheight)
                obj.ID = "obj" & dr("wui_id")
                AddHandler obj.Click, AddressOf Me.image_Click

                phMap.Controls.Add(obj)

                If WebLib.BitToBoolean(dr("wui_reject")) = True Then

                    obj = New ImageButton
                    obj.ImageUrl = WebLib.ClientURL("graphics/workflow/arrowrightred.png")
                    obj.Style.Add("width", lwidth)
                    obj.Style.Add("height", lheight)
                    obj.ID = "obj" & dr("wui_id") & "R"
                    phMap.Controls.Add(obj)

                    obj = New ImageButton
                    Select Case dr("wui_rejectstep")
                        Case "1"
                            obj.ImageUrl = WebLib.ClientURL("graphics/workflow/circleblue.png")
                        Case "3"
                            obj.ImageUrl = WebLib.ClientURL("graphics/workflow/circlegreen.png")
                        Case "4"
                            obj.ImageUrl = WebLib.ClientURL("graphics/workflow/circleyellow.png")

                        Case Else
                            obj.ImageUrl = WebLib.ClientURL("graphics/misc/blank.png")
                    End Select
                    obj.Style.Add("width", lwidth)
                    obj.Style.Add("height", lheight)
                    obj.ID = "obj" & dr("wui_id") & "RE"
                    phMap.Controls.Add(obj)

                Else
                    obj = New ImageButton
                    obj.ImageUrl = WebLib.ClientURL("graphics/misc/blank.png")
                    obj.Style.Add("width", lwidth)
                    obj.Style.Add("height", lheight)
                    obj.ID = "obj" & dr("wui_id") & "R"
                    phMap.Controls.Add(obj)

                    obj = New ImageButton
                    obj.ImageUrl = WebLib.ClientURL("graphics/misc/blank.png")
                    obj.Style.Add("width", lwidth)
                    obj.Style.Add("height", lheight)
                    obj.ID = "obj" & dr("wui_id") & "RE"
                    phMap.Controls.Add(obj)
                End If

                lit = New Literal
                lit.Text = "<br>"
                phMap.Controls.Add(lit)

                obj = New ImageButton
                obj.ImageUrl = WebLib.ClientURL("graphics/workflow/arrowdown.png")
                obj.Style.Add("width", "48px")
                obj.Style.Add("height", "48px")
                phMap.Controls.Add(obj)

                lit = New Literal
                lit.Text = "<br>"
                phMap.Controls.Add(lit)

                If dr("wui_approvestep") = "1" Then
                    obj = New ImageButton
                    obj.ImageUrl = WebLib.ClientURL("graphics/workflow/circleblue.png")
                    obj.Style.Add("width", lwidth)
                    obj.Style.Add("height", lheight)
                    obj.ID = "obj" & dr("wui_id") & "E"
                    phMap.Controls.Add(obj)

                    lit = New Literal
                    lit.Text = "<br>End of Workflow"
                    lit.ID = "lit00E"
                    phMap.Controls.Add(lit)

                    isEnd = True
                End If
            Next

            counter = 0
            cmd.CommandText = "Select * from workflowaudit where wfa_ucode='" & bid.Value & "' order by wfa_createon asc"
            ad.SelectCommand = cmd
            ad.Fill(ds, "datarecords2")

            For Each dr In ds.Tables("datarecords2").Rows
                counter = counter + 1

                lit = New Literal
                lit.Text = "<span>" & dr("wfa_createon").ToString.ToUpper & " : <b>" & dr("wfa_code").ToString.ToUpper & "</b> by " & dr("wfa_createby") & "</span><br>"
                phAudit.Controls.Add(lit)
            Next

            cn.Close()
            cmd.Dispose()
            cn.Dispose()
        Catch ex As Exception
            lblMessage.Text = WebLib.getAlertMessageStyle(ex.Message)
        End Try
    End Function

    Public Sub image_Click(ByVal sender As System.Object, ByVal e As System.EventArgs)

    End Sub

    Public Sub backpagepage(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Dim lid As String = WebLib.GetValue("workflowstatus", "wst_module", "wst_ucode", "'" & bid.Value & "'", "", "")
        Dim lURL As String = ""
        lURL = Redirector.Redirect(lid, bid.Value) & ""
        If lURL.Trim = "" Then
            Response.Redirect("postpage.aspx?NextPage=" & WebLib.ClientURL("modules/workflow/wbuilderpreview.aspx") & "&ga=" & rid.Value & " &ba=" & bid.Value)
        Else
            Response.Redirect("~/" & lURL)
        End If
    End Sub

End Class

