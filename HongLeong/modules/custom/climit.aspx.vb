Imports System.IO
Imports System.Data
Imports System.Data.SqlClient
Imports System.Data.OleDb
Imports System.Web
Imports System.Web.UI
Imports System.Web.UI.WebControls

Partial Public Class climit_class
    Inherits detailspage

    Private FORMCODE As String = "CLIMIT"  'Hardcoded for customised form
    Private fparam2total As Double = 0
    Private fparam3total As Double = 0
    Private NmSpaceDocNo As String = ""
    Private f_custype As String = "1|New;;2|Existing"

    'Generated by VI FEANDI SOFTLABS FORM GENERATOR (http://www.vifeandi.net) VER 2014.1

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        listingpage = "wlist.aspx"
        _FormsName = "Credit Limit Exceeded Form"
        TableName = "[zcustom_climit]"
        IDPField = ""
        IDField = "cus_id"
        AppIDField = ""
        MerchantIDField = "cus_merchantid"
        FilterField = "cus_filter"
        APPCode = "WORKFLOW"
        AddRights = ""
        DelRights = ""
        ModRights = ""
        ViewRights = ""
        FullRights = "CL0005"
        NmSpace = "zcustom_clexceed"
        NmSpaceDocNo = "zcustom_clexceed"

        wfb_bar.workflownamespace = NmSpace
        wfb_bar.custommode = True
        wfb_bar.overridemode = True

        wfb_bar.attachmentbycreatoronly = True

        cus_custype.Visible = False

        If Page.IsPostBack = False Then
            lblrefno.Text = "<b>Auto Generated</b>"

            cus_refno.Text = Request("rc") & ""
            WebLib.SetListItems(cus_custype, f_custype)

            If (Request("wp2") & "").Trim <> "" Then '2 always use for custcode
                Dim obj As New RuntimeCustomer
                Call obj.getInfo((Request("wp2") & "").Trim)
                ccode.Value = (Request("wp2") & "").Trim
                cus_company.Text = obj.CustName & ""
                cus_tclamount.Text = obj.TCLAmount
                cus_creditterms.Text = obj.TermsDescription
                Dim templi As ListItem
                templi = cus_custype.Items.FindByValue(2)
                cus_custype.SelectedIndex = cus_custype.Items.IndexOf(templi)
                obj = Nothing
            Else
                Dim templi As ListItem
                templi = cus_custype.Items.FindByValue(1)
                cus_custype.SelectedIndex = cus_custype.Items.IndexOf(templi)
            End If

            cus_accountholder.DataSource = backend.GetAccountHolders(WebLib.LoginUserCompanySelected)
            cus_accountholder.DataValueField = "salesrepcode"
            cus_accountholder.DataTextField = "usr_name"
            cus_accountholder.DataBind()
            cus_accountholder.Items.Insert(0, New ListItem("Please Select", ""))
        End If

        cus_refno.ReadOnly = True
        cus_creditlimit.Enabled = False
        cus_invoicecredit.Enabled = False
        cus_ordercredit.Enabled = False
        '        cus_openinvoice.enabled = False
        cus_credittotal.Enabled = False
        '       cus_openorders.enabled = False
        cus_tclamount.Enabled = False
        cus_creditterms.Enabled = False
        cus_pendinginv.Enabled = False
        cus_exceededamount.Enabled = False

        createdt.Value = DateTime.Now
        updatedt.Value = DateTime.Now

        visibleControl(True)

        Call InitLoad()
        Call enabledisablecustomer()

        wfb_bar.parentobj = mp

        Call assigninitvalues()

        If (wfb_bar.canAction()) Then
            lvlvalid.Value = "True"
        Else
            lvlvalid.Value = "False"
        End If

        If (WebLib.LoginIsFullAdmin = True And wfb_bar.Workflowended = False) Or (IsNumeric(rid.Value) = False And cus_accountholder.SelectedValue = "") Then
            cus_accountholder.Enabled = True
        Else
            cus_accountholder.Enabled = False
        End If
        cus_remarks.ValidationGroup = wfb_bar.wlevelAget().tostring.trim & "-"
        loadpr()
    End Sub

    Private Sub enabledisablecustomer()
        cus_company.Enabled = False
    End Sub

    Private Function ValidateForm()
        lblMessage.Text = ""
        Return True
    End Function

    Private Sub loadworkings()
        Dim cn As New OleDbConnection(connectionstring)
        Dim cmd As New OleDbCommand()
        Dim ad As New OleDb.OleDbDataAdapter()
        Dim ds As New DataSet()
        Dim counter As Integer = 0
        Dim dr As DataRow

        Call updatetotals(True)

        cn.Open()
        cmd.CommandText = "Select * from zcustom_genitems where cus_uid='" & ucode.Value & "' and cus_type='" & FORMCODE & "'"
        cmd.Connection = cn
        ad.SelectCommand = cmd
        ad.Fill(ds, "datarecords")

        Dim dt As DataTable = ds.Tables("datarecords")
        Dim dv As New DataView(dt)
        Dim lcount As Integer = dt.Rows.Count

        If lcount < 10 Then
            If cansaveitems() = True Then
                For counter = 1 To 10 - lcount
                    dr = dt.NewRow()
                    dt.Rows.Add(dr)
                Next
            End If
        Else
            If cansaveitems() = True Then
                dr = dt.NewRow()
                dt.Rows.Add(dr)
            End If
            'Dont need to do anutjing
        End If

        Dim pgitems As New PagedDataSource()
        pgitems.DataSource = dv
        rep.DataSource = pgitems
        rep.DataBind()
    End Sub

    Private Function SaveItems(ByVal pucode As String) As String
        Dim lseq As Integer = 0
        Dim lcus_param1 As String = ""
        Dim lcus_param2 As String = ""
        Dim lcus_param3 As String = ""
        Dim lcus_param4 As String = ""
        Dim lcus_param5 As String = ""
        Dim lcus_param6 As String = ""
        Dim lcus_uid As String = ""
        Dim lcus_type As String = FORMCODE
        Dim lsql As String = ""
        Dim myObject As Object
        Dim myObjectdd As Object

        lsql = "Delete from zcustom_genitems where cus_uid='" & pucode & "' and cus_type='" & FORMCODE & "'"

        For Each item In rep.Items
            lseq = lseq + 1

            myObject = item.FindControl("txtparam1")
            If Not myObject Is Nothing Then
                lcus_param1 = myObject.Text
            End If

            myObject = item.FindControl("txtparam2")
            If Not myObject Is Nothing Then
                lcus_param2 = myObject.Text
            End If

            myObject = item.FindControl("txtparam3")
            If Not myObject Is Nothing Then
                lcus_param3 = myObject.Text
            End If

            myObjectdd = item.FindControl("txtparam4")
            If Not myObjectdd Is Nothing Then
                lcus_param4 = myObjectdd.value
            End If

            myObject = item.FindControl("txtparam5")
            If Not myObject Is Nothing Then
                lcus_param5 = myObject.Text
            End If

            If lcus_param1.Trim = "" Then
            Else
                lsql = lsql & ";Insert into zcustom_genitems ([cus_param1],[cus_param2],[cus_param3],[cus_param4],[cus_param5],[cus_uid],[cus_type],cus_seq) Values (" &
                "'" & lcus_param1.Replace("'", "''") & "','" & lcus_param2.Replace("'", "''") & "','" & lcus_param3.Replace("'", "''") & "','" &
                lcus_param4.Replace("'", "''") & "','" & lcus_param5.Replace("'", "''") & "','" & pucode & "','" & lcus_type & "'," & lseq & ")"
            End If
        Next

        Return lsql

    End Function

    Private Function cansaveitems() As Boolean
        If wfb_bar.wlevelAget().tostring.trim = "1" Then
            Return True
        Else
            Return False
        End If
    End Function

    Protected Sub rep_ItemDataBound(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.RepeaterItemEventArgs) Handles rep.ItemDataBound
        Dim drv As DataRowView
        drv = e.Item.DataItem
        Dim objdata As Literal
        Dim objdata2 As TextBox
        Dim objdataDD As Object

        Dim lsubtotal As String
        Dim lGST As String
        Dim lLess As String
        Dim lTotal As String
        Dim templi As ListItem

        If cansaveitems() = True Then
            objdata = e.Item.FindControl("litparam1")
            If Not objdata Is Nothing Then
                objdata.Visible = False
            End If
            objdata = e.Item.FindControl("litparam2")
            If Not objdata Is Nothing Then
                objdata.Visible = False
            End If
            objdata = e.Item.FindControl("litparam3")
            If Not objdata Is Nothing Then
                objdata.Visible = False
            End If
            objdata = e.Item.FindControl("litparam4")
            If Not objdata Is Nothing Then
                objdata.Visible = False
            End If
            objdata = e.Item.FindControl("litparam5")
            If Not objdata Is Nothing Then
                objdata.Visible = False
            End If

            objdata2 = e.Item.FindControl("txtparam1")
            If Not objdata2 Is Nothing Then
                objdata2.Visible = True
            End If
            objdata2 = e.Item.FindControl("txtparam2")
            If Not objdata2 Is Nothing Then
                objdata2.Visible = True
            End If
            objdata2 = e.Item.FindControl("txtparam3")
            If Not objdata2 Is Nothing Then
                objdata2.Visible = True
            End If
            objdataDD = e.Item.FindControl("txtparam4")
            If Not objdataDD Is Nothing Then
                objdataDD.Visible = True
            End If
            objdata2 = e.Item.FindControl("txtparam5")
            If Not objdata2 Is Nothing Then
                objdata2.Visible = True
            End If


        Else
            objdata = e.Item.FindControl("litparam1")
            If Not objdata Is Nothing Then
                objdata.Visible = True
            End If
            objdata = e.Item.FindControl("litparam2")
            If Not objdata Is Nothing Then
                objdata.Visible = True
            End If
            objdata = e.Item.FindControl("litparam3")
            If Not objdata Is Nothing Then
                objdata.Visible = True
            End If
            objdata = e.Item.FindControl("litparam4")
            If Not objdata Is Nothing Then
                objdata.Visible = True
            End If
            objdata = e.Item.FindControl("litparam5")
            If Not objdata Is Nothing Then
                objdata.Visible = True
            End If

            objdata2 = e.Item.FindControl("txtparam1")
            If Not objdata2 Is Nothing Then
                objdata2.Visible = False
            End If

            objdata2 = e.Item.FindControl("txtparam2")
            If Not objdata2 Is Nothing Then
                objdata2.Visible = False
            End If
            objdata2 = e.Item.FindControl("txtparam3")
            If Not objdata2 Is Nothing Then
                objdata2.Visible = False
            End If
            objdataDD = e.Item.FindControl("txtparam4")
            If Not objdataDD Is Nothing Then
                objdataDD.Visible = False
            End If
            objdata2 = e.Item.FindControl("txtparam5")
            If Not objdata2 Is Nothing Then
                objdata2.Visible = False
            End If
        End If

        If IsNumeric(drv.Row("cus_param2").ToString & "") Then
            objdata2 = e.Item.FindControl("txtparam2")
            If Not objdata2 Is Nothing Then
                objdata2.Text = WebLib.formatthemoney(CDbl(drv.Row("cus_param2").ToString & ""))
            End If

            objdata = e.Item.FindControl("litparam2")
            If Not objdata Is Nothing Then
                objdata.Text = WebLib.formatthemoney(CDbl(drv.Row("cus_param2").ToString & ""))
            End If

            fparam2total = fparam2total + CDbl(drv.Row("cus_param2").ToString & "")
        End If

        If IsNumeric(drv.Row("cus_param3").ToString & "") Then
            objdata2 = e.Item.FindControl("txtparam3")
            If Not objdata2 Is Nothing Then
                objdata2.Text = WebLib.formatthemoney(CDbl(drv.Row("cus_param3").ToString & ""))
            End If

            objdata = e.Item.FindControl("litparam3")
            If Not objdata Is Nothing Then
                objdata.Text = WebLib.formatthemoney(CDbl(drv.Row("cus_param3").ToString & ""))
            End If

            fparam3total = fparam3total + CDbl(drv.Row("cus_param3").ToString & "")
        End If

        objdataDD = e.Item.FindControl("txtparam4")
        If Not objdataDD Is Nothing Then
            If IsDate(drv.Row("cus_param4")) = True Then
                objdataDD.value = CDate(drv.Row("cus_param4").ToString)
            End If
        End If

        objdata = e.Item.FindControl("litparam4")
        If Not objdata Is Nothing Then
            If IsDate(drv.Row("cus_param4")) = True Then
                objdata.Text = WebLib.formatthedate(CDate(drv.Row("cus_param4").ToString))
            End If
        End If

        Call updatetotals(False)

    End Sub

    Public Sub SetFieldRights()
        Call wfb_bar.EnableDisable(mp)
        Exit Sub
    End Sub

    Private Sub assigninitvalues()
    End Sub

    Public Sub backpagepage(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Response.Redirect(WebLib.ClientURL(Redirector.PrevURL1))
    End Sub

    Private Sub LoadCreditDetails()
        If (ccode.Value & "").Trim <> "" Then
            datats.Value = gettimestamp()
            Call assigntimestamp()

            Dim obj As New RuntimeCustomer
            Call obj.getCreditInfo(ccode.Value)
            cus_creditlimit.Text = WebLib.formatthemoney(obj.CreditLimit)
            cus_invoicecredit.Text = WebLib.formatthemoney(obj.InvoiceCredit)
            cus_ordercredit.Text = WebLib.formatthemoney(obj.OrderCredit)

            If IsNumeric(cus_invoicecredit.Text) = False Then
                cus_invoicecredit.Text = "0.00"
            End If
            If IsNumeric(cus_ordercredit.Text) = False Then
                cus_ordercredit.Text = "0.00"
            End If
            If IsNumeric(obj.ShipAmt) = False Then
                obj.ShipAmt = 0
            End If
            If IsNumeric(obj.InvoiceCreditUnposted) = False Then
                obj.InvoiceCreditUnposted = 0
            End If

            Try
                cus_pendinginv.Text = WebLib.formatthemoney(CDbl(obj.ShipAmt) + CDbl(obj.InvoiceCreditUnposted))
            Catch ex As Exception
            End Try

            cus_credittotal.Text = WebLib.formatthemoney(CDbl(cus_invoicecredit.Text) + CDbl(cus_ordercredit.Text) + CDbl(cus_pendinginv.Text))
            cus_exceededamount.Text = WebLib.formatthemoney(CDbl(cus_credittotal.Text) - CDbl(cus_creditlimit.Text))
            obj = Nothing
        End If
    End Sub

    Private Sub StandardFormatting()
        If IsNumeric(cus_tclamount.Text) = False Then
            cus_tclamount.Text = "0.00"
        Else
            cus_tclamount.Text = WebLib.formatthemoney(CDbl(cus_tclamount.Text.Trim))
        End If
        If IsNumeric(cus_creditlimit.Text) = False Then
            cus_creditlimit.Text = "0.00"
        Else
            cus_creditlimit.Text = WebLib.formatthemoney(CDbl(cus_creditlimit.Text.Trim))
        End If
        If IsNumeric(cus_credittotal.Text) = False Then
            cus_credittotal.Text = "0.00"
        Else
            cus_credittotal.Text = WebLib.formatthemoney(CDbl(cus_credittotal.Text.Trim))
        End If
        If IsNumeric(cus_pendinginv.Text) = False Then
            cus_pendinginv.Text = "0.00"
        Else
            cus_pendinginv.Text = WebLib.formatthemoney(CDbl(cus_pendinginv.Text.Trim))
        End If
        If IsNumeric(cus_exceededamount.Text) = False Then
            cus_exceededamount.Text = "0.00"
        Else
            cus_exceededamount.Text = WebLib.formatthemoney(CDbl(cus_exceededamount.Text.Trim))
        End If
        If IsNumeric(cus_requestamount.Text) = False Then
            cus_requestamount.Text = "0.00"
        Else
            cus_requestamount.Text = WebLib.formatthemoney(CDbl(cus_requestamount.Text.Trim))
        End If
    End Sub

    Public Overrides Function LoadData() As Boolean
        Dim cn As New OleDbConnection(connectionstring)
        Dim cmd As New OleDbCommand()
        Dim ad As New OleDb.OleDbDataAdapter()
        Dim ds As New DataSet()
        Dim counter As Integer = 0
        Dim dr As DataRow
        Dim templi As ListItem

        If IsNumeric(rid.Value) = False Then
            wfb_bar.uid = ""
            Call SetFieldRights()
            Call loadworkings()
            Call LoadCreditDetails()
            Call StandardFormatting()
            visibleControl(False)
            cus_accountholder.SelectedValue = backend.GetAccountHolder((Request("wp2") & "").Trim)
            Exit Function
        End If

        Try
            cmd.CommandText = "Select * from " & TableName & " where cus_id=" & rid.Value
            cmd.Connection = cn
            ad.SelectCommand = cmd
            ad.Fill(ds, "datarecords")

            For Each dr In ds.Tables("datarecords").Rows
                counter = counter + 1
                '***** STANDARD *****
                cus_company.Text = dr("cus_company") & ""
                ccode.Value = dr("cus_custcode") & ""
                ucode.Value = dr("cus_ucode") & ""
                cus_refno.Text = dr("cus_refno") & ""
                lblrefno.Text = dr("cus_uno") & ""
                wfb_bar.uid = ucode.Value
                '********************
                Try
                    cus_invoicecredit.Text = WebLib.formatthemoney(dr("cus_invoicecredit") & "")
                    If IsNumeric(cus_invoicecredit.Text) = False Then
                        cus_invoicecredit.Text = "0.00"
                    End If
                    cus_ordercredit.Text = WebLib.formatthemoney(dr("cus_ordercredit") & "")
                    If IsNumeric(cus_ordercredit.Text) = False Then
                        cus_ordercredit.Text = "0.00"
                    End If
                    cus_credittotal.Text = WebLib.formatthemoney(dr("cus_credittotal") & "")
                    cus_creditterms.Text = dr("cus_creditterms") & ""
                    cus_creditlimit.Text = WebLib.formatthemoney(dr("cus_creditlimit") & "")
                    cus_tclamount.Text = WebLib.formatthemoney(dr("cus_tclamount") & "")
                    cus_pendinginv.Text = WebLib.formatthemoney(dr("cus_pendinginv") & "")
                    cus_exceededamount.Text = WebLib.formatthemoney(dr("cus_exceededamount") & "")
                    cus_requestamount.Text = WebLib.formatthemoney(dr("cus_requestamount") & "")
                    datats.Value = dr("cus_datats") & ""

                    Call StandardFormatting()
                    Call assigntimestamp()
                Catch ex As Exception
                End Try

                createdt.Value = dr("cus_createdt").ToString.Trim
                updatedt.Value = dr("cus_updatedt").ToString.Trim

                If dr("cus_createdt").ToString.Trim >= New DateTime(2019, 9, 26, 0, 0, 0) Then
                    visibleControl(False)
                End If

                templi = cus_custype.Items.FindByValue(dr("cus_custype") & "")
                cus_custype.SelectedIndex = cus_custype.Items.IndexOf(templi)
                cus_accountholder.SelectedValue = dr("cus_accountholder") & ""

                Exit For
            Next

            cn.Close()
            cmd.Dispose()
            cn.Dispose()

            If wfb_bar.Workflowended = True Then
                btnsave.enabled = False
            Else
                btnsave.enabled = True
            End If

            Call SetFieldRights()
            Call enabledisablecustomer()
            Call loadworkings()
            loaddraft()
        Catch ex As Exception
            lblMessage.Text = WebLib.getAlertMessageStyle(ex.Message)
        End Try
    End Function

    Private Function assigntimestamp()
        littimestamp.Text = "Data Extracted As Of : " & datats.Value
    End Function

    Private Function gettimestamp() As String
        Return System.DateTime.Now
    End Function

    Private Sub savedatadata(ByVal pWorkflowAction As Boolean, ByVal pType As String)
        Dim insertfields, insertvalues As String
        Dim lsrdesc As String = ""
        Dim lsql As String = ""
        insertfields = ""
        insertvalues = ""

        If ValidateForm() = False Then
            Exit Sub
        End If

        Dim lcus_invoicecredit As String = "0"
        Dim lcus_openinvoice As String = "0"
        Dim lcus_ordercredit As String = "0"
        Dim lcus_openorders As String = "0"
        Dim lcus_credittotal As String = "0"
        Dim lcus_creditterms As String = ""
        Dim lcus_creditlimit As String = "0"
        Dim lcus_tclamount As String = "0"
        Dim lcus_pendinginv As String = "0"
        Dim lcus_exceededamount As String = "0"
        Dim lcus_requestamount As String = "0"

        If IsNumeric(cus_pendinginv.Text) = True Then
            lcus_pendinginv = cus_pendinginv.Text.Replace("'", "''").Replace(",", "")
        End If
        If IsNumeric(cus_invoicecredit.Text) = True Then
            lcus_invoicecredit = cus_invoicecredit.Text.Replace("'", "''").Replace(",", "")
        End If
        If IsNumeric(cus_ordercredit.Text) = True Then
            lcus_ordercredit = cus_ordercredit.Text.Replace("'", "''").Replace(",", "")
        End If
        If IsNumeric(cus_credittotal.Text) = True Then
            lcus_credittotal = cus_credittotal.Text.Replace("'", "''").Replace(",", "")
        End If
        lcus_creditterms = cus_creditterms.Text.Replace("'", "''")
        If IsNumeric(cus_creditlimit.Text) = True Then
            lcus_creditlimit = cus_creditlimit.Text.Replace("'", "''").Replace(",", "")
        End If
        If IsNumeric(cus_tclamount.Text) = True Then
            lcus_tclamount = cus_tclamount.Text.Replace("'", "''").Replace(",", "")
        End If
        If IsNumeric(cus_exceededamount.Text) = True Then
            lcus_exceededamount = cus_exceededamount.Text.Replace("'", "''").Replace(",", "")
        End If
        If IsNumeric(cus_requestamount.Text) = True Then
            lcus_requestamount = cus_requestamount.Text.Replace("'", "''").Replace(",", "")
        End If

        If IIf(createdt.Value = "", Today.Date, createdt.Value) >= New DateTime(2022, 6, 7) Then
            If cus_custype.SelectedItem.Text = "New" Then
                If wfb_bar.wlevelAget() <> "" Then
                    If wfb_bar.wlevelNameget() = "Intermediate Group President" Then
                        wfb_bar.wfAppLimit = "800000.00"
                    End If
                End If
                wfb_bar.DocumentAmt = cus_requestamount.Text

            ElseIf cus_custype.SelectedItem.Text = "Existing" Then
                Dim calculatedCL As Double
                calculatedCL = CDbl(cus_creditlimit.Text) * CDbl(ConfigurationManager.AppSettings("WfTCLPtg"))

                If wfb_bar.wlevelAget() <> "" And wfb_bar.wfAppLimit <> "" Then
                    If CDbl(cus_requestamount.Text) > CDbl(calculatedCL) Then ' excess TCL Ptg 20%
                        wfb_bar.DocumentAmt = CDbl(cus_requestamount.Text) + CDbl(cus_creditlimit.Text)
                    Else ' within TCL Ptg 20%
                        wfb_bar.DocumentAmt = CDbl(cus_requestamount.Text)
                    End If
                End If
            End If
        Else
            wfb_bar.DocumentAmt = cus_requestamount.Text
        End If

        Try
            If rid.Value = "" Then

                ucode.Value = WebLib.getUniqueKey
                Dim lID As String
                Dim lDocno As String = ""
                lDocno = WebLib.GetDocNo(NmSpaceDocNo, "cus_uno", APPCode) & ""
                If lDocno.Trim = "" Then
                    lblMessage.Text = WebLib.getAlertMessageStyle("Document No. Not Set")
                    Exit Sub
                End If

                lID = WebLib.GetValue("Workflowlink", "wfl_wflowid", "wfl_subcode", "'" & FORMCODE & "'", "", "")
                If IsNumeric(lID) = False Or (lID & "").Trim = "0" Then
                    lblMessage.Text = WebLib.getAlertMessageStyle("No Workflow Assign for this form")
                    Exit Sub
                End If

                lsql = wfb_bar.GetWorkFlowSaveSQL(lID, ucode.Value, True, cus_refno.Text, NmSpace, _FormsName, cus_company.Text, lDocno)


                '**** CUSTOMISED ******'
                If cansaveitems() = True Then
                    If (lsql & "").Trim <> "" Then
                        lsql = lsql & ";"
                    End If
                    lsql = lsql & SaveItems(ucode.Value)
                    '*****
                End If

                insertfields = insertfields & "cus_merchantid"
                insertvalues = insertvalues & "'" & ccode.Value.Replace("'", "''") & "'"
                insertfields = insertfields & ",cus_uno"
                insertvalues = insertvalues & ",'" & lDocno & "'"
                insertfields = insertfields & ",cus_filter"
                insertvalues = insertvalues & ",'" & WebLib.FilterCode.replace("'", "''") & "'"
                insertfields = insertfields & ",cus_ucode"
                insertvalues = insertvalues & ",'" & ucode.Value & "'"
                insertfields = insertfields & ",cus_custcode"
                insertvalues = insertvalues & ",'" & ccode.Value.Replace("'", "''") & "'"
                insertfields = insertfields & ",cus_company"
                insertvalues = insertvalues & ",'" & cus_company.Text.Replace("'", "''") & "'"
                insertfields = insertfields & ",cus_refno"
                insertvalues = insertvalues & ",'" & cus_refno.Text.Replace("'", "''") & "'"
                insertfields = insertfields & ",cus_custype"
                insertvalues = insertvalues & ",'" & cus_custype.SelectedItem.Value & "'"

                '*** custom ***************************
                insertfields = insertfields & ",cus_invoicecredit"
                insertvalues = insertvalues & "," & lcus_invoicecredit & ""
                insertfields = insertfields & ",cus_openinvoice"
                insertvalues = insertvalues & "," & lcus_openinvoice & ""
                insertfields = insertfields & ",cus_ordercredit"
                insertvalues = insertvalues & "," & lcus_ordercredit & ""
                insertfields = insertfields & ",cus_openorders"
                insertvalues = insertvalues & "," & lcus_openorders & ""
                insertfields = insertfields & ",cus_credittotal"
                insertvalues = insertvalues & "," & lcus_credittotal & ""
                insertfields = insertfields & ",cus_creditterms"
                insertvalues = insertvalues & ",'" & lcus_creditterms & "'"
                insertfields = insertfields & ",cus_creditlimit"
                insertvalues = insertvalues & "," & lcus_creditlimit & ""
                insertfields = insertfields & ",cus_tclamount"
                insertvalues = insertvalues & "," & lcus_tclamount & ""
                insertfields = insertfields & ",cus_pendinginv"
                insertvalues = insertvalues & ",'" & lcus_pendinginv & "'"
                insertfields = insertfields & ",cus_exceededamount"
                insertvalues = insertvalues & ",'" & lcus_exceededamount & "'"
                insertfields = insertfields & ",cus_requestamount"
                insertvalues = insertvalues & ",'" & lcus_requestamount & "'"
                insertfields = insertfields & ",cus_datats"
                insertvalues = insertvalues & ",'" & datats.Value & "'"
                '*******************************

                insertfields = insertfields & ",cus_createby"
                insertvalues = insertvalues & ",'" & WebLib.LoginUser.replace("'", "''") & "'"
                insertfields = insertfields & ",cus_createdt"
                insertvalues = insertvalues & ",getdate()"
                insertfields = insertfields & ",cus_updateby"
                insertvalues = insertvalues & ",'" & WebLib.LoginUser.replace("'", "''") & "'"
                insertfields = insertfields & ",cus_updatedt"
                insertvalues = insertvalues & ",getdate()"
                insertfields = insertfields & ",cus_accountholder"
                insertvalues = insertvalues & ",'" & cus_accountholder.SelectedValue & "'"

            Else
                If pWorkflowAction = True Then
                    lsql = wfb_bar.getapprovesql(pType)
                End If

                If cansaveitems() = True Then
                    If (lsql & "").Trim <> "" Then
                        lsql = lsql & ";"
                    End If
                    lsql = lsql & SaveItems(ucode.Value)
                End If

                insertvalues = insertvalues & "cus_updateby='" & WebLib.LoginUser.replace("'", "''") & "'"
                insertvalues = insertvalues & ",cus_updatedt=getdate()"
                If cus_company.Enabled = True Then
                    insertvalues = insertvalues & ",cus_company='" & cus_company.Text.Replace("'", "''") & "'"
                End If

                '********** CUSTOM ***************
                If cus_pendinginv.Enabled = True Then
                    insertvalues = insertvalues & ",cus_pendinginv='" & lcus_pendinginv & "'"
                End If
                If cus_invoicecredit.Enabled = True Then
                End If
                If cus_ordercredit.Enabled = True Then
                End If
                If cus_credittotal.Enabled = True Then
                End If
                If cus_creditterms.Enabled = True Then
                End If
                If cus_creditlimit.Enabled = True Then
                End If
                If cus_tclamount.Enabled = True Then
                End If
                If cus_exceededamount.Enabled = True Then
                End If
                If cus_requestamount.Enabled = True Then
                    insertvalues = insertvalues & ",cus_requestamount='" & lcus_requestamount & "'"
                End If
                If cus_accountholder.Enabled = True Then
                    insertvalues = insertvalues & ",cus_accountholder='" & cus_accountholder.SelectedValue & "'"
                End If
                '********************************
            End If

            Dim lsqlcom As String = ""
            lsqlcom = lsqlcom & "'" & WebLib.LoginUser.replace("'", "''") & "'"
            lsqlcom = lsqlcom & ",'" & cus_remarks.Text.Replace("'", "''") & "'"
            lsqlcom = lsqlcom & ",getdate()"

            wfb_bar.postComments(lsqlcom, TableName, pWorkflowAction)

            If savedata(insertfields, insertvalues, True, lsql) = True Then
                If pType = "" Then
                    pType = "route"
                End If

                If pWorkflowAction = True Then
                    If wfb_bar.notifyusers(pType) = False Then
                    End If
                End If
                Response.Redirect("~/" & Redirector.Redirect(NmSpace, ucode.Value, False))
            Else
                lblMessage.Text = WebLib.getAlertMessageStyle("There is an error while saving. Please retry")
            End If
        Catch Err As Exception
            lblMessage.Text = WebLib.getAlertMessageStyle(Err.Message)
        Finally
        End Try
    End Sub

    Private Sub updatetotals(ByVal pReset As Boolean)
        Try
            If pReset = True Then
                fparam2total = 0
                fparam3total = 0
            End If
            If IsNumeric(fparam2total) = False Then
                fparam2total = 0
            End If
            If IsNumeric(fparam3total) = False Then
                fparam3total = 0
            End If
            littotalparam2.Text = WebLib.formatthemoney(fparam2total)
            littotalparam3.Text = WebLib.formatthemoney(fparam3total)
        Catch ex As Exception
        End Try
    End Sub

    Public Sub savepage(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Call savedatadata(False, "")
    End Sub

    Protected Sub wfb_bar_OnApproveEvent(ByVal sender As Object, ByVal e As EventArgs) Handles wfb_bar.OnApproveEvent
        Call savedatadata(True, "Approve")
    End Sub

    Protected Sub wfb_bar_OnRejectEvent(ByVal sender As Object, ByVal e As EventArgs) Handles wfb_bar.OnRejectEvent
        Call savedatadata(True, "Reject")
    End Sub

    Protected Sub wfb_bar_OnCancelEvent(ByVal sender As Object, ByVal e As EventArgs) Handles wfb_bar.OnCancelEvent
        Call savedatadata(True, "Cancel")
    End Sub

    Public Sub loadpr()
        Try
            rep_comment.DataSource = wfb_bar.getComments2()
            rep_comment.DataBind()
            rep_audit.DataSource = wfb_bar.GetAuditLogsDs2()
            rep_audit.DataBind()
        Catch ex As Exception
            lblMessage.Text = WebLib.getAlertMessageStyle(ex.Message)
        End Try
    End Sub

    Public Sub loaddraft()
        Try
            cus_remarks.Text = wfb_bar.getDraft2()
        Catch ex As Exception
            lblMessage.Text = WebLib.getAlertMessageStyle(ex.Message)
        End Try
    End Sub

    Private Function visibleControl(ByVal bvisible As Boolean)
        cus_tclamount.Visible = bvisible
        tblrep.Visible = bvisible
        cus_requestamount.Visible = IIf(bvisible = False, True, False)
    End Function

End Class

