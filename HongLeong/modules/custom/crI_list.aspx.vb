Imports System.IO
Imports System.Data
Imports System.Data.SqlClient
Imports System.Data.OleDb
Imports System.Web
Imports System.Web.UI
Imports System.Web.UI.WebControls
Partial Public Class crI_list_class
    Inherits listpage
    'Generated by VI FEANDI SOFTLABS FORM GENERATOR (http://www.vifeandi.net) VER 2014.1
    Private FORMCODE As String = "CRI"  'Hardcoded for customised form


    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        _searchkeystr = "cus_customer;Customer Name;S|cus_crno;CR No.;S|usr_name;Submitted By;S|cus_createdt;Submission Date;D"

        listingpage = ""
        _FormsName = "Change Request Form - Internal CR"
        'columnscount = "10"
        TableName = "zcustom_crI"
        DetailPage = ""
        IDPField = ""
        IDField = "cus_id"
        AppIDField = ""
        MerchantIDField = ""
        FilterField = "cus_filter"
        Orderby = ""
        '_pagesize = 20
        APPCode = "WORKFLOW" '"SMS"
        AddRights = "" '"SM0001"
        DelRights = "" ' "SM0003"
        ModRights = "" '"SM0002"
        ViewRights = "" '"SM0004"
        FullRights = "BB0005"
        NmSpace = "zcustom_crI"

        backend.DeleteOldDraft(TableName)

        'pFieldNames = " workflowstatus.*,zcustom_crI.*,usr_name,ApprovalLevelName = (" & clsWorkflow.getLevelNameSQL("wst_workflowid", "wst_level") & ") "
        pFieldNames = " * from ( Select workflowstatus.*, " & TableName & ".*,ApprovalLevelName = wui_name, tempwfi.[value] as [rights] "

        'pJoinFields = " inner join workflowstatus on cus_ucode = wst_ucode left outer join secuserinfo on cus_createby = usr_loginid "
        pJoinFields = "inner join workflowstatus on cus_ucode = wst_ucode " &
                        "left join (Select * From workflowitems Cross apply string_split(replace(isnull(wui_rights,''),';;',',') + '0',',') where value <> 0 ) tempwfi on tempwfi.wui_wid=wst_workflowid and isnull(tempwfi.wui_no,0)=wst_level " &
                        "left outer join secuserinfo on cus_createby = usr_loginid ) as k "
        '"inner join wgrouprights on wur_wgroupid = rights and wur_wgroupid not in (49) left join secuserinfo secwur on wur_uid = secwur.usr_id "

        LogtheAudit("Select " + _selectprefix + " " + pFieldNames + " from " + TableName + " " + pJoinFields + " ")

        If Page.IsPostBack = False Then
            bid.Value = Request("ba")
            wfid.Value = WebLib.GetValue("Workflowlink", "wfl_wflowid", "wfl_subcode", "'" & FORMCODE & "'", "", "")
            '_searchfilter = " wst_status='Pending' and (cus_createby='" & WebLib.LoginUser & "' or '" & WebLib.LoginUser & "' in (" & clsWorkflow.getUserCodebyWorkFlowSQL("wst_workflowid", "wst_level") & ")) "
            _searchfilter = " wst_status='Pending' and (cus_createby='" & WebLib.LoginUser & "' or '" & WebLib.LoginUser & "' in (" & clsWorkflow.getUserCodebyWorkFlowSQL("wst_workflowid", "wst_level") & ")) "


            dept.DataSource = backend.GetDepartmentList()
            dept.DataValueField = "de_id"
            dept.DataTextField = "de_name"
            dept.DataBind()
            dept.Items.Insert(0, New ListItem("Please Select", ""))

            category.DataSource = backend.GetCategoryListAS()
            category.DataValueField = "cat_id"
            category.DataTextField = "cat_description"
            category.DataBind()
            category.Items.Insert(0, New ListItem("Please Select", ""))

            module1.DataSource = backend.GetModuleListAS()
            module1.DataValueField = "mod_id"
            module1.DataTextField = "mod_description"
            module1.DataBind()
            module1.Items.Insert(0, New ListItem("Please Select", ""))

            customer.DataSource = backend.GetCustomerList()
            customer.DataValueField = "cu_code"
            customer.DataTextField = "cu_name"
            customer.DataBind()
            customer.Items.Insert(0, New ListItem("Please Select", ""))

            priority1.DataSource = backend.GetPriorityList()
            priority1.DataValueField = "cm_description"
            priority1.DataTextField = "cm_description"
            priority1.DataBind()
            priority1.Items.Insert(0, New ListItem("Please Select", ""))

            pendinglevel.DataSource = backend.GetLevelList(1045)
            pendinglevel.DataValueField = "wui_name"
            pendinglevel.DataTextField = "wui_name"
            pendinglevel.DataBind()
            pendinglevel.Items.Insert(0, New ListItem("Please Select", ""))

            pendingperson.DataSource = backend.GetUserList()
            pendingperson.DataValueField = "usr_name"
            pendingperson.DataTextField = "usr_name"
            pendingperson.DataBind()
            pendingperson.Items.Insert(0, New ListItem("Please Select", ""))

            tags.Items.Clear()
            Call WebLib.setListItemsTable(tags, "cm_description", "cm_description", "codemaster", "cm_id", "", "", "", " cm_fieldname = 'tags' ")

        Else
            _searchfilter = ""

        End If
        bid.Value = "zcustom_crI"

        Call InitLoad()

        btnback.Visible = False
        Redirector.PrevURL1 = "modules/custom/crI_list.aspx"
        btnadd.Visible = True

        If WebLib.LoginUser.ToLower.Trim = "ops" Or WebLib.LoginUser.ToLower.Trim = "admin" Then
            btnadd.Enabled = True
        End If

        Call LoadFilterButtons()

    End Sub
    Protected Sub rep_ItemCommand(ByVal source As Object, ByVal e As System.Web.UI.WebControls.RepeaterCommandEventArgs) Handles rep.ItemCommand


    End Sub
    Protected Sub rep_ItemDataBound(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.RepeaterItemEventArgs) Handles rep.ItemDataBound


        Dim drv As DataRowView
        drv = e.Item.DataItem

        'Dim objdata As Literal = e.Item.FindControl("litData")
        'If Not objdata Is Nothing Then
        '    Dim llink As String

        '    Dim lCode As String
        '    Dim lstatus As String = ""
        '    If (drv.Row("wst_status").ToString.Trim) = "Pending" Then
        '        lstatus = "Pending <b>" & (drv.Row("ApprovalLevelName").ToString.Trim & "</b>")
        '    Else
        '        lstatus = (drv.Row("wst_status").ToString.Trim)
        '    End If
        '    llink = WebLib.ClientURL(Redirector.Redirect(drv.Row("wst_module").ToString.Trim, drv.Row("wst_ucode").ToString.Trim))

        '    lCode = "<table width=""100%"">"
        '    lCode = lCode & "<tr><td width=""10%"" class=""cssdetail"">Customer</td><td class=""cssdetail"" width=""2%"">:</td><td class=""cssdetail"" width=""88%"">" & drv.Row("cus_company").ToString.Trim & "</td></tr>"
        '    lCode = lCode & "<tr><td width=""10%"" class=""cssdetail"">Distributor</td><td class=""cssdetail"" width=""2%"">:</td><td class=""cssdetail"" width=""88%"">" & drv.Row("cus_distributor").ToString.Trim & "</td></tr>"
        '    lCode = lCode & "<tr><td class=""cssdetail"">Doc Type</td><td class=""cssdetail"">:</td><td class=""cssdetail""><b>" & drv.Row("wst_subject").ToString.Trim & "</b></td></tr>"
        '    lCode = lCode & "<tr><td class=""cssdetail"">Doc Ref</td><td class=""cssdetail"">:</td><td class=""cssdetail"">" & drv.Row("cus_uno").ToString.Trim & "</td></tr>"
        '    lCode = lCode & "<tr><td class=""cssdetail"">Created By</td><td class=""cssdetail"">:</td><td class=""cssdetail"">" & drv.Row("usr_name").ToString.Trim & " " & drv.Row("wst_createon").ToString.Trim & "</td></tr>"
        '    lCode = lCode & "<tr><td class=""cssdetail"">Status</td><td class=""cssdetail"">:</td><td class=""cssdetail""><b>" & lstatus & "</b></td></tr>"

        '    If drv.Row("wst_refno").ToString.Trim <> "" Then
        '        lCode = lCode & "<tr><td class=""cssdetail"">Ticket No.</td><td class=""cssdetail"">:</td><td class=""cssdetail""><b>" & drv.Row("wst_refno").ToString.Trim & "</b></td></tr>"
        '    End If


        '    lCode = lCode & "<tr><td class=""cssdetail""></td><td class=""cssdetail""></td><td class=""cssdetail""><a href=""" & llink & """>View Document</a></td></tr>"
        '    lCode = lCode & "</table>"

        '    objdata.Text = lCode

        'End If


        Dim objdata As Literal = e.Item.FindControl("litimage")
        If Not objdata Is Nothing Then
            'objdata.Text = "<img src=""" & WebLib.ClientURL("graphics/workflow/paper.png") & """ width=""48"">"
            objdata.Text = "<a href=""" & WebLib.ClientURL(Redirector.Redirect(drv.Row("wst_module").ToString.Trim, drv.Row("wst_ucode").ToString.Trim)) & """><img src=""" & WebLib.ClientURL("graphics/workflow/paper.png") & """ width=""48""></a>"

        End If

    End Sub
    Public Sub shortcut1(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Call loaddata(" wst_status='Pending' ")

    End Sub
    Private Sub LoadFilterButtons()
        Dim cn As New OleDbConnection(connectionstring)
        Dim cmd As New OleDbCommand()
        Dim ad As New OleDb.OleDbDataAdapter()
        Dim ds As New DataSet()
        Dim counter As Integer = 0
        Dim dr As DataRow
        Dim lsql As String = ""

        Dim lwfid As String = wfid.Value
        lsql = clsWorkflow.getLevelsbyWorkflowID(lwfid)

        Dim obj As Object
        obj = Page.FindControl("phFilters")

        If Not obj Is Nothing Then
            Try
                cn.Open()
                cmd.CommandText = lsql
                cmd.Connection = cn
                ad.SelectCommand = cmd
                ad.Fill(ds, "datarecords")
                For Each dr In ds.Tables("datarecords").Rows
                    counter = counter + 1
                    Dim obj1 As New Button
                    obj1.ID = "ID" & dr("recno")
                    obj1.Style.Add("width", "160px")
                    obj1.Text = dr("wui_name")
                    obj1.CssClass = "btn btn-sm btn-secondary w-100 m-1"
                    '                    obj1.Style.Add("height", "20")
                    'word-wrap:break-word;
                    obj1.Style.Add("display", "inline")
                    obj1.Style.Add("white-space", "normal")

                    obj1.Style.Add("word-wrap", "break-word")
                    obj1.Style.Add("text-align", "left")

                    AddHandler obj1.Click, AddressOf Me.filterclick
                    obj.Controls.Add(obj1)
                Next
                cn.Close()
                cmd.Dispose()
                cn.Dispose()

            Catch ex As Exception


            End Try

        End If


    End Sub
    Public Sub filterclick(ByVal sender As System.Object, ByVal e As System.EventArgs)

        Dim lLevel As String
        lLevel = sender.id.ToString.Replace("ID", "")

        If IsNumeric(lLevel) = False Then
            lLevel = 0
        End If
        filterhead.Text = "Filter : <b>" & sender.Text & "</b>"
        Call loaddata(" wst_status='Pending' and wst_level=" & lLevel)

    End Sub
    Public Sub shortcutmy(ByVal sender As System.Object, ByVal e As System.EventArgs)
        filterhead.Text = "Filter : <b>" & sender.Text & "</b>"
        Call loaddata(" wst_status='Pending' and ('" & WebLib.LoginUser & "' in (" & clsWorkflow.getUserCodebyWorkFlowSQL("wst_workflowid", "wst_level") & ")) ")
    End Sub

    Public Sub shortcut2(ByVal sender As System.Object, ByVal e As System.EventArgs)
        filterhead.Text = "Filter : <b>" & sender.Text & "</b>"
        Call loaddata(" wst_status='Approved' ")

    End Sub
    Public Sub AddEventAdd(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Response.Redirect("~/" & Redirector.Redirect(bid.Value, "", True))

    End Sub
    Public Sub shortcut3(ByVal sender As System.Object, ByVal e As System.EventArgs)
        filterhead.Text = "Filter : <b>" & sender.Text & "</b>"
        Call loaddata(" wst_status='Cancelled' ")

    End Sub
    Public Sub shortcut4(ByVal sender As System.Object, ByVal e As System.EventArgs)
        filterhead.Text = "Filter : <b>" & sender.Text & "</b>"
        Call loaddata(" wst_status='Rejected' ")

    End Sub

    Protected Sub SearchtheData()
        Dim lFilterStatement As String = ""
        Dim theObject As Object = Nothing


        'theObject = Page.Master.FindControl("ContentArea").FindControl("docno")
        theObject = docno.Text
        If theObject IsNot Nothing Then
            If (theObject & "").Trim <> "" Then
                If (lFilterStatement & "").Trim <> "" Then
                    lFilterStatement = lFilterStatement & " and "
                End If
                lFilterStatement = lFilterStatement & WebSearchCR.CR_DocumentNo(theObject)
            End If
        End If

        'theObject = Page.Master.FindControl("ContentArea").FindControl("docno")
        theObject = requestTitle.Text
        If theObject IsNot Nothing Then
            If (theObject & "").Trim <> "" Then
                If (lFilterStatement & "").Trim <> "" Then
                    lFilterStatement = lFilterStatement & " and "
                End If
                lFilterStatement = lFilterStatement & WebSearchCR.CR_RequestTitle(theObject)
            End If
        End If

        'theObject = Page.Master.FindControl("ContentArea").FindControl("dept")
        theObject = dept.SelectedValue
        If theObject IsNot Nothing Then
            If (theObject & "").Trim <> "" Then
                If (lFilterStatement & "").Trim <> "" Then
                    lFilterStatement = lFilterStatement & " and "
                End If
                lFilterStatement = lFilterStatement & WebSearchCR.CR_Department(theObject)
            End If
        End If

        'theObject = Page.Master.FindControl("ContentArea").FindControl("category")
        theObject = category.SelectedValue
        If theObject IsNot Nothing Then
            If (theObject & "").Trim <> "" Then
                If (lFilterStatement & "").Trim <> "" Then
                    lFilterStatement = lFilterStatement & " and "
                End If
                lFilterStatement = lFilterStatement & WebSearchCR.CR_Category(theObject)
            End If
        End If

        'theObject = Page.Master.FindControl("ContentArea").FindControl("module1")
        theObject = module1.SelectedValue
        If theObject IsNot Nothing Then
            If (theObject & "").Trim <> "" Then
                If (lFilterStatement & "").Trim <> "" Then
                    lFilterStatement = lFilterStatement & " and "
                End If
                lFilterStatement = lFilterStatement & WebSearchCR.CR_Module(theObject)
            End If
        End If

        'theObject = Page.Master.FindControl("ContentArea").FindControl("customer")
        theObject = customer.SelectedValue
        If theObject IsNot Nothing Then
            If (theObject & "").Trim <> "" Then
                If (lFilterStatement & "").Trim <> "" Then
                    lFilterStatement = lFilterStatement & " and "
                End If
                lFilterStatement = lFilterStatement & WebSearchCR.CR_Customer(theObject)
            End If
        End If

        'theObject = Page.Master.FindControl("ContentArea").FindControl("priority1")
        theObject = priority1.SelectedValue
        If theObject IsNot Nothing Then
            If (theObject & "").Trim <> "" Then
                If (lFilterStatement & "").Trim <> "" Then
                    lFilterStatement = lFilterStatement & " and "
                End If
                lFilterStatement = lFilterStatement & WebSearchCR.CR_Priority(theObject)
            End If
        End If

        'theObject = Page.Master.FindControl("ContentArea").FindControl("description")
        theObject = techReq.Text
        If theObject IsNot Nothing Then
            If (theObject & "").Trim <> "" Then
                If (lFilterStatement & "").Trim <> "" Then
                    lFilterStatement = lFilterStatement & " and "
                End If
                lFilterStatement = lFilterStatement & WebSearchCR.CR_TechnicalReq(theObject)
            End If
        End If

        'theObject = Page.Master.FindControl("ContentArea").FindControl("tags")
        theObject = tags.SelectedValue
        If theObject IsNot Nothing Then
            If (theObject & "").Trim <> "" Then
                If (lFilterStatement & "").Trim <> "" Then
                    lFilterStatement = lFilterStatement & " and "
                End If
                lFilterStatement = lFilterStatement & WebSearchCR.CR_Tags(theObject)
            End If
        End If

        'theObject = Page.Master.FindControl("ContentArea").FindControl("status")
        theObject = status.SelectedValue
        If theObject IsNot Nothing Then
            If (theObject & "").Trim <> "" Then
                If (lFilterStatement & "").Trim <> "" Then
                    lFilterStatement = lFilterStatement & " and "
                End If
                lFilterStatement = lFilterStatement & WebSearchCR.CR_Status(theObject)
            End If
        End If

        'theObject = Page.Master.FindControl("ContentArea").FindControl("pendinglevel")
        theObject = pendinglevel.SelectedValue
        If theObject IsNot Nothing Then
            If (theObject & "").Trim <> "" Then
                If (lFilterStatement & "").Trim <> "" Then
                    lFilterStatement = lFilterStatement & " and "
                End If
                lFilterStatement = lFilterStatement & WebSearchCR.CR_PendingLevel(theObject)
            End If
        End If

        'theObject = Page.Master.FindControl("ContentArea").FindControl("pendingperson")
        theObject = pendingperson.SelectedValue
        If theObject IsNot Nothing Then
            If (theObject & "").Trim <> "" Then
                If (lFilterStatement & "").Trim <> "" Then
                    lFilterStatement = lFilterStatement & " and "
                End If
                lFilterStatement = lFilterStatement & WebSearchCR.CR_PendingPerson(theObject, clsWorkflow.getUserCodebyWorkFlowSQL("wst_workflowid", "wst_level"))
            End If
        End If

        Dim lfromdate As String = ""
        theObject = fromdate.Textdmy
        If theObject IsNot Nothing Then
            If (theObject & "").Trim <> "" Then
                lfromdate = WebLib.FormatDateFullFormatDDMMYYYYtoYYYYMMDD(theObject.ToString())
            End If
        End If


        Dim ltodate As String = ""
        theObject = todate.Textdmy
        If theObject IsNot Nothing Then
            If (theObject & "").Trim <> "" Then
                ltodate = WebLib.FormatDateFullFormatDDMMYYYYtoYYYYMMDD(theObject.ToString())
            End If
        End If

        If IsNumeric(lfromdate) = True And IsNumeric(ltodate) = False Then
            ltodate = lfromdate
        End If
        If IsNumeric(ltodate) = True And IsNumeric(lfromdate) = False Then
            lfromdate = ltodate
        End If

        If IsNumeric(lfromdate) = False Or IsNumeric(ltodate) = False Then
            'Not Compulsory
        Else

            If (lFilterStatement & "").Trim <> "" Then
                lFilterStatement = lFilterStatement & " and "
            End If
            lFilterStatement = lFilterStatement & "(" & WebSearchCR.CR_CreateDate(lfromdate, 0, ">=") & " and " & WebSearchCR.CR_CreateDate(ltodate, 0, "<=") & ")"

        End If

        If lFilterStatement.Trim <> "" Then
            '_searchfilter = _searchfilter & "" & lFilterStatement
            Call loaddata(lFilterStatement)
        End If

    End Sub

    Public Sub LogtheAudit(ByVal theMessage As String)
        Dim strFile As String = "c:\officeonelog\ErrorLog3.txt"
        Dim fileExists As Boolean = File.Exists(strFile)

        Try

            Using sw As New StreamWriter(File.Open(strFile, FileMode.Append))
                sw.WriteLine(DateTime.Now & " - " & theMessage)

            End Using
        Catch ex As Exception

        End Try
    End Sub

End Class

