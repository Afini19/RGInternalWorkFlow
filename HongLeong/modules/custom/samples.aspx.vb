Imports System.IO
Imports System.Data
Imports System.Data.SqlClient
Imports System.Data.OleDb
Imports System.Web
Imports System.Web.UI
Imports System.Web.UI.WebControls

Partial Public Class samples_class
    Inherits detailspage

    Private FORMCODE As String = "SAMPLES"  'Hardcoded for customised form
    Private f_type As String = "OPC;;PCC;;MASONRY;;GGBS;;BLENDED;;PLC;;OTHERS"
    Private f_business As String = "PRECAST;;RMX;;IU;;OTHERS"
    Private f_trial As String = "PLANT;;LAB;;SITE TESTING;;OTHERS"

    'Generated by VI FEANDI SOFTLABS FORM GENERATOR (http://www.vifeandi.net) VER 2014.1

    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        listingpage = "wlist.aspx"
        _FormsName = "Customer Sample Form"
        TableName = "[zcustom_samples]"
        IDPField = ""
        IDField = "cus_id"
        AppIDField = ""
        MerchantIDField = "cus_merchantid"
        FilterField = "cus_filter"
        APPCode = "WORKFLOW"
        AddRights = ""
        DelRights = ""
        ModRights = ""
        ViewRights = ""
        FullRights = "PT0005"
        NmSpace = "zcustom_samples"

        wfb_bar.workflownamespace = NmSpace
        wfb_bar.custommode = True
        wfb_bar.overridemode = True
        wfb_bar.attachmentbycreatoronly = True
        cus_custype.Enabled = False

        If Page.IsPostBack = False Then
            lblrefno.Text = "<b>Auto Generated</b>"

            cus_refno.Text = Request("rc") & ""

            WebLib.SetListItems(cus_typeofsample, f_type)
            WebLib.SetListItems(cus_business, f_business)
            WebLib.SetListItems(cus_typeoftest, f_trial)

            If (Request("wp2") & "").Trim <> "" Then '2 always use for custcode
                Dim obj As New RuntimeCustomer
                Call obj.getInfo((Request("wp2") & "").Trim)
                ccode.Value = (Request("wp2") & "").Trim
                cus_company.Text = obj.CustName & ""
                obj = Nothing
            Else
            End If

            cus_accountholder.DataSource = backend.GetAccountHolders(WebLib.LoginUserCompanySelected)
            cus_accountholder.DataValueField = "salesrepcode"
            cus_accountholder.DataTextField = "usr_name"
            cus_accountholder.DataBind()
            cus_accountholder.Items.Insert(0, New ListItem("Please Select", ""))
        End If
        createdt.Value = DateTime.Now

        cus_refno.ReadOnly = True

        Call InitLoad()
        Call enabledisablecustomer()

        wfb_bar.parentobj = mp

        Call assigninitvalues()

        If (wfb_bar.canAction()) Then
            lvlvalid.Value = "True"
        Else
            lvlvalid.Value = "False"
        End If

        If (WebLib.LoginIsFullAdmin = True And wfb_bar.Workflowended = False) Or (IsNumeric(rid.Value) = False And cus_accountholder.SelectedValue = "") Then
            cus_accountholder.Enabled = True
        Else
            cus_accountholder.Enabled = False
        End If

        cus_remarks.ValidationGroup = wfb_bar.wlevelAget().tostring.trim & "-"

        loadpr()

    End Sub

    Private Sub enabledisablecustomer()
        cus_company.Enabled = False
    End Sub

    Private Function ValidateForm()
        lblMessage.Text = ""

        If cus_duration.enabled = True Then
            If (cus_duration.textdmy) <> "" Then
                If cus_duration.datevalue = New DateTime(1991, 1, 1) Then
                    lblMessage.Text = WebLib.getAlertMessageStyle("Date Sample Needed at Site")
                    Return False
                End If
            End If
        End If

        If cus_qty.Enabled = True Then
            If IsNumeric(cus_qty.Text) = False Then
                lblMessage.Text = WebLib.getAlertMessageStyle("Please Enter Valid Quantity")
                Return False
            End If
        End If

        Return True
    End Function

    Public Sub SetFieldRights()
        Call wfb_bar.EnableDisable(mp)
        Exit Sub
    End Sub

    Private Sub assigninitvalues()
        If cus_duration.enabled = False And (cus_duration.value & "").trim = "" Then
            cus_duration.textdmy = ""
        End If
    End Sub

    Public Sub backpagepage(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Response.Redirect(WebLib.ClientURL(Redirector.PrevURL1))
    End Sub

    Public Overrides Function LoadData() As Boolean
        Dim cn As New OleDbConnection(connectionstring)
        Dim cmd As New OleDbCommand()
        Dim ad As New OleDb.OleDbDataAdapter()
        Dim ds As New DataSet()
        Dim counter As Integer = 0
        Dim dr As DataRow
        Dim templi As ListItem

        If IsNumeric(rid.Value) = False Then
            wfb_bar.uid = ""
            Call SetFieldRights()
            cus_accountholder.SelectedValue = backend.GetAccountHolder((Request("wp2") & "").Trim)
            Exit Function
        End If

        Try
            cmd.CommandText = "Select * from " & TableName & " where cus_id=" & rid.Value
            cmd.Connection = cn
            ad.SelectCommand = cmd
            ad.Fill(ds, "datarecords")

            For Each dr In ds.Tables("datarecords").Rows
                counter = counter + 1
                cus_company.Text = dr("cus_company") & ""
                ccode.Value = dr("cus_custcode") & ""
                ucode.Value = dr("cus_ucode") & ""

                cus_address.Text = dr("cus_address") & ""
                cus_contact.Text = dr("cus_contact") & ""
                cus_contactno.Text = dr("cus_contactno") & ""
                cus_distributor.Text = dr("cus_distributor") & ""
                cus_distributorsales.Text = dr("cus_distributorsales") & ""
                cus_distributorsalescontactno.Text = dr("cus_distributorsalescontactno") & ""

                templi = cus_typeofsample.Items.FindByValue(dr("cus_typeofsample") & "")
                cus_typeofsample.SelectedIndex = cus_typeofsample.Items.IndexOf(templi)

                templi = cus_business.Items.FindByValue(dr("cus_business") & "")
                cus_business.SelectedIndex = cus_business.Items.IndexOf(templi)

                templi = cus_typeoftest.Items.FindByValue(dr("cus_typeoftest") & "")
                cus_typeoftest.SelectedIndex = cus_typeoftest.Items.IndexOf(templi)

                cus_mix.Text = dr("cus_mix") & ""

                Try
                    cus_qty.Text = dr("cus_qty") & ""

                    If IsNumeric(cus_qty.Text) = False Then
                        cus_qty.Text = "0"
                    End If
                Catch ex As Exception
                End Try

                Try
                    cus_duration.Textdmy = dr("cus_duration") & ""
                Catch ex As Exception
                End Try

                cus_refno.Text = dr("cus_refno") & ""
                lblrefno.Text = dr("cus_uno") & ""

                wfb_bar.uid = ucode.Value
                cus_accountholder.SelectedValue = dr("cus_accountholder") & ""
                createdt.Value = dr("cus_createdt").ToString.Trim

                loaddraft()

                Exit For
            Next
            cn.Close()
            cmd.Dispose()
            cn.Dispose()
            If wfb_bar.Workflowended = True Then
                btnsave.enabled = False
            Else
                btnsave.enabled = True
            End If

            Call SetFieldRights()
            Call enabledisablecustomer()

        Catch ex As Exception
            lblMessage.Text = WebLib.getAlertMessageStyle(ex.Message)
        End Try

    End Function

    Private Sub savedatadata(ByVal pWorkflowAction As Boolean, ByVal pType As String)
        Dim insertfields, insertvalues As String
        Dim lsrdesc As String = ""
        Dim lsql As String = ""
        Dim newform As Boolean = False
        Dim savedDraft As String = ""
        insertfields = ""
        insertvalues = ""

        If ValidateForm() = False Then
            Exit Sub
        End If

        Dim lduration As String = ""
        'If cus_asat.enabled = True Then
        If cus_duration.datevalue = New DateTime(1991, 1, 1) Then
            lduration = "NULL"
        Else
            lduration = "'" & WebLib.formatthedate(cus_duration.datevalue) & "'"
        End If

        Dim lcus_typeofsample As String = ""
        If cus_typeofsample.SelectedIndex < 0 Then
            lcus_typeofsample = ""
        Else
            lcus_typeofsample = cus_typeofsample.SelectedItem.Value
        End If

        Dim lcus_business As String = ""
        If cus_business.SelectedIndex < 0 Then
            lcus_business = ""
        Else
            lcus_business = cus_business.SelectedItem.Value
        End If

        Dim lcus_typeoftest As String = ""
        If cus_typeoftest.SelectedIndex < 0 Then
            lcus_typeoftest = ""
        Else
            lcus_typeoftest = cus_typeoftest.SelectedItem.Value
        End If

        Try
            If rid.Value = "" Then
                savedDraft = "saved"
                newform = True
                ucode.Value = WebLib.getUniqueKey

                Dim lID As String
                Dim lDocno As String = ""
                lDocno = WebLib.GetDocNo(NmSpace, "cus_uno", APPCode) & ""
                If lDocno.Trim = "" Then
                    lblMessage.Text = WebLib.getAlertMessageStyle("Document No. Not Set")
                    Exit Sub
                End If

                lID = WebLib.GetValue("Workflowlink", "wfl_wflowid", "wfl_subcode", "'" & FORMCODE & "'", "", "")
                If IsNumeric(lID) = False Or (lID & "").Trim = "0" Then
                    lblMessage.Text = WebLib.getAlertMessageStyle("No Workflow Assign for this form")
                    Exit Sub
                End If

                lsql = wfb_bar.GetWorkFlowSaveSQL(lID, ucode.Value, True, cus_refno.Text, NmSpace, _FormsName, cus_company.Text, lDocno)

                insertfields = insertfields & "cus_merchantid"
                insertvalues = insertvalues & "'" & ccode.Value.Replace("'", "''") & "'"
                insertfields = insertfields & ",cus_uno"
                insertvalues = insertvalues & ",'" & lDocno & "'"
                insertfields = insertfields & ",cus_filter"
                insertvalues = insertvalues & ",'" & WebLib.FilterCode.replace("'", "''") & "'"
                insertfields = insertfields & ",cus_ucode"
                insertvalues = insertvalues & ",'" & ucode.Value & "'"
                insertfields = insertfields & ",cus_custcode"
                insertvalues = insertvalues & ",'" & ccode.Value.Replace("'", "''") & "'"
                insertfields = insertfields & ",cus_company"
                insertvalues = insertvalues & ",'" & cus_company.Text.Replace("'", "''") & "'"
                insertfields = insertfields & ",cus_refno"
                insertvalues = insertvalues & ",'" & cus_refno.Text.Replace("'", "''") & "'"
                insertfields = insertfields & ",cus_qty"
                insertvalues = insertvalues & "," & cus_qty.Text.Replace("'", "''") & ""
                'insertfields = insertfields & ",cus_remarks2"
                'insertvalues = insertvalues & ",'" & cus_remarks2.Text.Replace("'", "''") & "'"
                'insertfields = insertfields & ",cus_remarks3"
                'insertvalues = insertvalues & ",'" & cus_remarks3.Text.Replace("'", "''") & "'"
                'insertfields = insertfields & ",cus_remarks4"
                'insertvalues = insertvalues & ",'" & cus_remarks4.Text.Replace("'", "''") & "'"
                'insertfields = insertfields & ",cus_remarks5"
                'insertvalues = insertvalues & ",'" & cus_remarks5.Text.Replace("'", "''") & "'"
                'insertfields = insertfields & ",cus_remarks6"
                'insertvalues = insertvalues & ",'" & cus_remarks6.Text.Replace("'", "''") & "'"
                'insertfields = insertfields & ",cus_remarks7"
                'insertvalues = insertvalues & ",'" & cus_remarks7.Text.Replace("'", "''") & "'"
                'insertfields = insertfields & ",cus_remarks8"
                'insertvalues = insertvalues & ",'" & cus_remarks8.Text.Replace("'", "''") & "'"
                'insertfields = insertfields & ",cus_remarks9"
                'insertvalues = insertvalues & ",'" & cus_remarks9.Text.Replace("'", "''") & "'"

                '*** custom **
                insertfields = insertfields & ",cus_address"
                insertvalues = insertvalues & ",'" & cus_address.Text.Replace("'", "''") & "'"
                insertfields = insertfields & ",cus_contact"
                insertvalues = insertvalues & ",'" & cus_contact.Text.Replace("'", "''") & "'"
                insertfields = insertfields & ",cus_contactno"
                insertvalues = insertvalues & ",'" & cus_contactno.Text.Replace("'", "''") & "'"
                insertfields = insertfields & ",cus_distributor"
                insertvalues = insertvalues & ",'" & cus_distributor.Text.Replace("'", "''") & "'"
                insertfields = insertfields & ",cus_distributorsales"
                insertvalues = insertvalues & ",'" & cus_distributorsales.Text.Replace("'", "''") & "'"
                insertfields = insertfields & ",cus_distributorsalescontactno"
                insertvalues = insertvalues & ",'" & cus_distributorsalescontactno.Text.Replace("'", "''") & "'"
                insertfields = insertfields & ",cus_typeofsample"
                insertvalues = insertvalues & ",'" & lcus_typeofsample & "'"
                insertfields = insertfields & ",cus_business"
                insertvalues = insertvalues & ",'" & lcus_business & "'"
                insertfields = insertfields & ",cus_duration"
                insertvalues = insertvalues & "," & lduration & ""
                insertfields = insertfields & ",cus_mix"
                insertvalues = insertvalues & ",'" & cus_mix.Text.Replace("'", "''") & "'"
                insertfields = insertfields & ",cus_typeoftest"
                insertvalues = insertvalues & ",'" & lcus_typeoftest & "'"
                '****

                insertfields = insertfields & ",cus_createby"
                insertvalues = insertvalues & ",'" & WebLib.LoginUser.replace("'", "''") & "'"
                insertfields = insertfields & ",cus_createdt"
                insertvalues = insertvalues & ",getdate()"
                insertfields = insertfields & ",cus_updateby"
                insertvalues = insertvalues & ",'" & WebLib.LoginUser.replace("'", "''") & "'"
                insertfields = insertfields & ",cus_updatedt"
                insertvalues = insertvalues & ",getdate()"
                insertfields = insertfields & ",cus_accountholder"
                insertvalues = insertvalues & ",'" & cus_accountholder.SelectedValue & "'"

            Else
                If pWorkflowAction = True Then
                    lsql = wfb_bar.getapprovesql(pType)
                Else
                    savedDraft = "saved"
                    newform = True
                End If

                insertvalues = insertvalues & "cus_updateby='" & WebLib.LoginUser.replace("'", "''") & "'"
                insertvalues = insertvalues & ",cus_updatedt=getdate()"

                If cus_company.Enabled = True Then
                    insertvalues = insertvalues & ",cus_company='" & cus_company.Text.Replace("'", "''") & "'"
                End If
                If cus_qty.Enabled = True Then
                    insertvalues = insertvalues & ",cus_qty=" & cus_qty.Text.Replace("'", "''") & ""
                End If
                If cus_address.Enabled = True Then
                    insertvalues = insertvalues & ",cus_address='" & cus_address.Text.Replace("'", "''") & "'"
                End If
                If cus_contact.Enabled = True Then
                    insertvalues = insertvalues & ",cus_contact='" & cus_contact.Text.Replace("'", "''") & "'"
                End If
                If cus_contactno.Enabled = True Then
                    insertvalues = insertvalues & ",cus_contactno='" & cus_contactno.Text.Replace("'", "''") & "'"
                End If
                If cus_distributor.Enabled = True Then
                    insertvalues = insertvalues & ",cus_distributor='" & cus_distributor.Text.Replace("'", "''") & "'"
                End If
                If cus_distributorsales.Enabled = True Then
                    insertvalues = insertvalues & ",cus_distributorsales='" & cus_distributorsales.Text.Replace("'", "''") & "'"
                End If
                If cus_distributorsalescontactno.Enabled = True Then
                    insertvalues = insertvalues & ",cus_distributorsalescontactno='" & cus_distributorsalescontactno.Text.Replace("'", "''") & "'"
                End If
                If cus_typeofsample.Enabled = True Then
                    insertvalues = insertvalues & ",cus_typeofsample='" & lcus_typeofsample & "'"
                End If
                If cus_business.Enabled = True Then
                    insertvalues = insertvalues & ",cus_business='" & lcus_business & "'"
                End If
                If cus_duration.Enabled = True Then
                    insertvalues = insertvalues & ",cus_duration=" & lduration & ""
                End If
                If cus_mix.Enabled = True Then
                    insertvalues = insertvalues & ",cus_mix='" & cus_mix.Text.Replace("'", "''") & "'"
                End If
                If cus_typeoftest.Enabled = True Then
                    insertvalues = insertvalues & ",cus_typeoftest='" & lcus_typeoftest & "'"
                End If
                If cus_accountholder.Enabled = True Then
                    insertvalues = insertvalues & ",cus_accountholder='" & cus_accountholder.SelectedValue & "'"
                End If
            End If


            Dim lsqlcom As String = ""
            lsqlcom = lsqlcom & "'" & WebLib.LoginUser.replace("'", "''") & "'"
            lsqlcom = lsqlcom & ",'" & IIf(cus_remarks.Text = "", "[Please refer to above section.]", cus_remarks.Text.Replace("'", "''")) & "'"
            lsqlcom = lsqlcom & ",getdate()"

            wfb_bar.postComments(lsqlcom, TableName, pWorkflowAction)

            If savedata(insertfields, insertvalues, True, lsql) = True Then
                If pType = "" Then
                    pType = "route"
                End If

                If pWorkflowAction = True Then
                    If wfb_bar.notifyusers(pType) = False Then

                    End If
                End If
                Response.Redirect("~/" & Redirector.Redirect(NmSpace, ucode.Value, False))
            Else
                lblMessage.Text = WebLib.getAlertMessageStyle("There is an error while saving. Please retry")
            End If
        Catch Err As Exception
            lblMessage.Text = WebLib.getAlertMessageStyle(Err.Message)
        Finally
        End Try
    End Sub

    Public Sub savepage(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Call savedatadata(False, "")
    End Sub

    Protected Sub wfb_bar_OnApproveEvent(ByVal sender As Object, ByVal e As EventArgs) Handles wfb_bar.OnApproveEvent
        Call savedatadata(True, "Approve")
    End Sub

    Protected Sub wfb_bar_OnRejectEvent(ByVal sender As Object, ByVal e As EventArgs) Handles wfb_bar.OnRejectEvent
        Call savedatadata(True, "Reject")
    End Sub

    Protected Sub wfb_bar_OnCancelEvent(ByVal sender As Object, ByVal e As EventArgs) Handles wfb_bar.OnCancelEvent
        Call savedatadata(True, "Cancel")
    End Sub

    Public Sub loadpr()
        Try
            rep_comment.DataSource = wfb_bar.getComments2()
            rep_comment.DataBind()
            rep_audit.DataSource = wfb_bar.GetAuditLogsDs2()
            rep_audit.DataBind()
        Catch ex As Exception
            lblMessage.Text = WebLib.getAlertMessageStyle(ex.Message)
        End Try
    End Sub

    Public Sub loaddraft()
        Try
            cus_remarks.Text = wfb_bar.getDraft2()
        Catch ex As Exception
            lblMessage.Text = WebLib.getAlertMessageStyle(ex.Message)
        End Try
    End Sub

End Class

