Imports System.IO
Imports System.Data
Imports System.Data.SqlClient
Imports System.Data.OleDb
Imports System.Web
Imports System.Web.UI
Imports System.Web.UI.WebControls
Partial Public Class secdatagroupusers_class
    Inherits detailspage

    'Generated by VI FEANDI SOFTLABS FORM GENERATOR (http://www.vifeandi.net) VER 2014.1
    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        listingpage = "secuserinfolist.aspx"
        _FormsName = "Security : Data Group Users"
        TableName = "secdatagroupusers"
        IDPField = ""
        IDField = "sdgu_id"
        AppIDField = ""
        MerchantIDField = ""
        FilterField = ""
        APPCode = "GENERAL"
        AddRights = "SU0001"
        DelRights = "SU0003"
        ModRights = "SU0002"
        ViewRights = "SU0004"
        FullRights = ""
        NmSpace = "secuse"

        Call InitLoad()

        If Page.IsPostBack = False Then
            bid.Value = Request("ba")
            rid.Value = Request("ga")

            Call WebLib.setListItemsTable(usr_profile, "pf_name", "pf_id", "secuserprofile", "pf_name", "", "", "", "")
            Call loaddata("")
        End If
    End Sub

    Protected Sub searchdata(ByVal sender As System.Object, ByVal e As System.EventArgs)
        If usr_profile.SelectedIndex < 0 Then
            Call loaddata("")
        Else
            Call loaddata(" usr_profile=" & usr_profile.SelectedItem.Value & "")
        End If
    End Sub

    Private Function ValidateForm()
        lblMessage.Text = ""
        Return True
    End Function

    Public Sub loaddata(Optional ByVal _p_searchkey As String = "")
        If _p_searchkey.Trim = "" Then
            Exit Sub
        End If

        If IsNumeric(rid.Value) = False Then
            Response.Redirect(listingpage)
        End If

        Dim cn As New OleDbConnection(connectionstring)
        Dim cmd As New OleDbCommand()
        Dim ad As New OleDb.OleDbDataAdapter()
        Dim ds As New DataSet()
        Dim counter As Integer = 0
        Dim dr As DataRow

        If _p_searchkey.Trim <> "" Then
            _p_searchkey = " and " & _p_searchkey
        End If

        cn.Open()
        cmd.CommandText = "Select * from secuserinfo left outer join secdatagroupusers on secuserinfo.usr_code = sdgu_supervisorcode and sdgu_usrcode=(select usr_code from secuserinfo where usr_id='" & rid.Value & "') where rtrim(isnull(usr_merchantid,'')) = '' " & _p_searchkey

        LogtheAudit(cmd.CommandText)

        cmd.Connection = cn
        ad.SelectCommand = cmd
        ad.Fill(ds, "datarecords")

        Dim dt As DataTable = ds.Tables("datarecords")
        Dim dv As New DataView(dt)

        Dim pgitems As New PagedDataSource()
        pgitems.DataSource = dv
        rep.DataSource = pgitems
        rep.DataBind()
    End Sub

    Public Sub savepage(ByVal sender As System.Object, ByVal e As System.EventArgs)
        Dim cn As New OleDbConnection(connectionstring)
        Dim itrans As OleDbTransaction
        Dim cmd As New OleDbCommand()
        Dim counter As Integer = 0
        Dim bcheck As Boolean = False
        Dim lsql As String = ""
        cn.Open()
        cmd.Connection = cn

        lsql = "Delete from secdatagroupusers where sdgu_usrcode='" & WebLib.GetValue("secuserinfo", "usr_code", "usr_id", rid.Value, "", "") & "'"

        Dim item As RepeaterItem

        For Each item In rep.Items
            Dim lFull As String = ""
            Dim myCheckBox5 As CheckBox = item.FindControl("chkfull")
            If Not myCheckBox5 Is Nothing Then
                bcheck = myCheckBox5.Checked
            Else
                bcheck = False
            End If

            Dim lID As String = ""
            Dim mtTextBox2 As HiddenField = item.FindControl("txtid")
            If Not mtTextBox2 Is Nothing Then
                lID = mtTextBox2.Value
            End If

            If lID.Trim = "" Then
                GoTo NextItem
            End If

            If bcheck = True Then
                lsql = lsql & ";Insert into [secdatagroupusers] (sdgu_supervisorcode,sdgu_usrcode,sdgu_filter,sdgu_merchantid,sdgu_module,sdgu_updateby,sdgu_updatedt) " &
                    " Values ('" & WebLib.GetValue("secuserinfo", "usr_code", "usr_id", lID, "", "") & "','" & WebLib.GetValue("secuserinfo", "usr_code", "usr_id", rid.Value, "", "") & "', " &
                    "'" & WebLib.FilterCode & "','','SMP','" & WebLib.LoginUser & "',getdate())"
            End If

            Try
                itrans = cn.BeginTransaction()
                cmd.Transaction = itrans
                cmd.CommandText = lsql
                cmd.ExecuteNonQuery()
                itrans.Commit()
            Catch Err As Exception
                Try
                    itrans.Rollback()
                Catch ex As Exception
                End Try
                lblMessage.Text = Err.Message
            End Try
NextItem:
        Next

        Call gotoback()
    End Sub

    Protected Sub rep_ItemDataBound(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.RepeaterItemEventArgs) Handles rep.ItemDataBound
        Dim drv As DataRowView
        drv = e.Item.DataItem

        Dim myCheckBox5 As CheckBox = e.Item.FindControl("chkfull")
        If Not myCheckBox5 Is Nothing Then
            If myCheckBox5.ToolTip.Trim = "" Then
                myCheckBox5.Visible = False
            Else
                If drv.Row("sdgu_supervisorcode").ToString.Trim = drv.Row("usr_code").ToString.Trim Then
                    myCheckBox5.Checked = True
                Else
                    myCheckBox5.Checked = False
                End If
            End If
        End If
    End Sub

End Class

