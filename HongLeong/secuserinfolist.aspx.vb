Imports System.IO
Imports System.Data
Imports System.Data.SqlClient
Imports System.Data.OleDb
Imports System.Web
Imports System.Web.UI
Imports System.Web.UI.WebControls
Partial Public Class secuse_list_class
    Inherits listpage

    'Generated by VI FEANDI SOFTLABS FORM GENERATOR (http://www.vifeandi.net) VER 2014.1
    Protected Sub Page_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        _searchkeystr = "u.usr_code;User Code;S|u.usr_name;User Name;S|pf_name;User Profile;S|bbranch;Branch;S|"
        listingpage = "secuserinfolist.aspx"
        _FormsName = "Security Center - User Info "
        TableName = "secuserinfo u "
        DetailPage = "secuserinfo.aspx"
        IDPField = ""
        IDField = "u.usr_id"
        AppIDField = ""
        MerchantIDField = ""
        FilterField = ""
        Orderby = ""
        APPCode = "GENERAL"
        AddRights = "SU0001"
        DelRights = "SU0003"
        ModRights = "SU0002"
        ViewRights = "SU0004"
        FullRights = ""
        NmSpace = "secuse"

        pFieldNames = " u.usr_id,u.usr_code,u.usr_name,de_name as usr_department,usr_expiry,usr_disable,u.usr_createby,u.usr_createdt, pf_name as usr_profile,bbranch,bright "

        'pJoinFields = " inner join Department on usr_department = de_id inner join secuserprofile on usr_profile = pf_id " &
        '    "left join (select usr_code, STUFF((SELECT ', ' + br_code_new FROM branch where br_code in (SELECT ITEM FROM SplitString(replace(usr_branch, ' ',''), ',')) group by br_code_new FOR XML PATH ('')), 1, 1, '') as bbranch from secuserinfo su where rtrim(isnull(usr_merchantid,'')) = '') b on b.usr_code = u.usr_code " &
        '    "left join (select usr_code, STUFF((SELECT ', ' + br_code_new FROM branch where br_code in (select ub_brcode from UserBranchRights where ub_usrcode = su.usr_code) group by br_code_new FOR XML PATH ('')), 1, 1, '') as bright	from secuserinfo su where rtrim(isnull(usr_merchantid,'')) = '') br on br.usr_code = u.usr_code "

        pJoinFields = " inner join Department on usr_department = de_id inner join secuserprofile on usr_profile = pf_id " &
            "left join (select usr_code, STUFF((SELECT ', ' + br_code_new FROM branch group by br_code_new FOR XML PATH ('')), 1, 1, '') as bbranch from secuserinfo su where rtrim(isnull(usr_merchantid,'')) = '') b on b.usr_code = u.usr_code " &
            "left join (select usr_code, STUFF((SELECT ', ' + br_code_new FROM branch group by br_code_new FOR XML PATH ('')), 1, 1, '') as bright	from secuserinfo su where rtrim(isnull(usr_merchantid,'')) = '') br on br.usr_code = u.usr_code "


        LogtheAudit("Select " + _selectprefix + " " + pFieldNames + " from " + TableName + " " + pJoinFields + " ")

        Dim branch() As String = WebLib.BranchID.Split(",")

        Dim branchitem As String = ""
        For Each item As String In branch
            If branchitem <> "" Then
                branchitem = branchitem & " or "
            End If
            branchitem = branchitem & " usr_branch = '" & item.Replace(" ", "") & "' "
        Next

        '_searchfilter = " rtrim(isnull(usr_merchantid,'')) = '' and usr_company like N'%" & WebLib.LoginUserCompanySelected & "%'  "
        'If WebLib.LoginIsFullAdmin = True Then
        '    _searchfilter = " rtrim(isnull(u.usr_merchantid,'')) = '' "
        'Else
        '    _searchfilter = " rtrim(isnull(u.usr_merchantid,'')) = '' and (u.usr_branch = '" & WebLib.BranchID & "' or " & branchitem & ") "
        'End If

        btnback.Visible = False
        Call InitLoad()

    End Sub

    Protected Sub rep_ItemCommand(ByVal source As Object, ByVal e As System.Web.UI.WebControls.RepeaterCommandEventArgs) Handles rep.ItemCommand
        If e.CommandName = "Edit" Then
            Response.Redirect("postpage.aspx?NextPage=" & DetailPage & "&ga=" & e.CommandArgument & "&ba=" & bid.Value)
        End If
        If e.CommandName = "Del" Then
            'Call removeFromUserBranchRights(e.CommandArgument)
            Call DeleteRec(e.CommandArgument)
        End If
        If e.CommandName = "Users" Then
            Response.Redirect("postpage.aspx?NextPage=secdatagroupusers.aspx&ga=" & e.CommandArgument & "&ba=" & bid.Value)
        End If
    End Sub

    Protected Sub rep_ItemDataBound(ByVal sender As Object, ByVal e As System.Web.UI.WebControls.RepeaterItemEventArgs) Handles rep.ItemDataBound
        Dim objEdit As Object = e.Item.FindControl("lnkEdit")
        If Not objEdit Is Nothing Then
            If WebLib.hasrights(NmSpace, APPCode, ModRights) = False Then
                Try
                    objEdit.Visible = False
                Catch ex As Exception
                End Try
            End If
        End If
        Dim objDel As Object = e.Item.FindControl("lnkDelete")
        If Not objDel Is Nothing Then
            If WebLib.hasrights(NmSpace, APPCode, DelRights) = False Then
                Try
                    objDel.Visible = False
                Catch ex As Exception
                End Try
            End If
        End If
        Dim objReportTo As Object = e.Item.FindControl("lnkReportTo")
        If Not objReportTo Is Nothing Then
            If WebLib.hasrights(NmSpace, APPCode, ModRights) = False Then
                Try
                    objReportTo.Visible = False
                Catch ex As Exception
                End Try
            End If
        End If
    End Sub

    Public Function removeFromUserBranchRights(ByVal userid As String) As Boolean
        Dim cn As New OleDbConnection(connectionstring)
        Dim itrans As OleDbTransaction
        Dim cmd As New OleDbCommand()
        Dim counter As Integer = 0
        Dim lSql As String = ""

        Dim merchantid As String = WebLib.MerchantID

        cn.Open()
        cmd.Connection = cn

        lSql = "Delete from [UserBranchRights] where ub_filter='" & WebLib.FilterCode & "' and ub_usrcode='" & WebLib.GetValue(TableName, "usr_code", "usr_id", "'" & userid & "'", "", "") & "'"

        Try
            itrans = cn.BeginTransaction()
            cmd.Transaction = itrans
            cmd.CommandText = lSql
            cmd.ExecuteNonQuery()
            itrans.Commit()
        Catch Err As Exception
            Return False
        End Try

        Return True
    End Function

    Public Sub LogtheAudit(ByVal theMessage As String)
        Dim strFile As String = "c:\officeonelog\ErrorLog3.txt"
        Dim fileExists As Boolean = File.Exists(strFile)

        Try

            Using sw As New StreamWriter(File.Open(strFile, FileMode.Append))
                sw.WriteLine(DateTime.Now & " - " & theMessage)

            End Using
        Catch ex As Exception

        End Try
    End Sub

End Class

